-------------------------------------------------------------------
--     	Select STACK 1 and 2
-------------------------------------------------------------------
USE
	weiboDEV
GO
Select 
	 [dbo].[STACK_1_EQ_STREETBLOCKS].[STREETBLOCKID]
	,[AvgCoh_20090328_20090408_1]  --STACK 1
	,[AvgCoh_20090328_20090419_2]  --STACK 1
	,[AvgCoh_20090328_20090511_3]  --STACK 1
	,[AvgCoh_20090328_20090522_4]  --STACK 1
	,[AvgCoh_20090328_20090602_5]  --STACK 1
	,[AvgCoh_20090328_20090624_6]  --STACK 1
	,[AvgCoh_20090408_20090419_7]  --STACK 1
	,[AvgCoh_20090408_20090511_8]  --STACK 1
	,[AvgCoh_20090408_20090522_9]  --STACK 1
	,[AvgCoh_20090408_20090602_10] --STACK 1
	,[AvgCoh_20090419_20090511_11] --STACK 1
	,[AvgCoh_20090419_20090522_12] --STACK 1
	,[AvgCoh_20090419_20090602_13] --STACK 1
	,[AvgCoh_20090419_20090624_14] --STACK 1
	,[AvgCoh_20090511_20090522_15] --STACK 1
	,[AvgCoh_20090511_20090602_16] --STACK 1
	,[AvgCoh_20090511_20090624_17] --STACK 1
	,[AvgCoh_20090522_20090602_18] --STACK 1
	,[AvgCoh_20090522_20090624_19] --STACK 1
	,[AvgCoh_20090624_20090829_20] --STACK 1
	,[AvgCoh_20090624_20090920_21] --STACK 1
	,[AvgCoh_20090829_20091012_22] --STACK 1
	,[AvgCoh_20090829_20091023_23] --STACK 1
	,[AvgCoh_20090920_20091012_24] --STACK 1
	,[AvgCoh_20090920_20091023_25] --STACK 1
	,[AvgCoh_20090920_20091114_26] --STACK 1
	,[AvgCoh_20090920_20091206_27] --STACK 1
	,[AvgCoh_20090920_20091217_28] --STACK 1
	,[AvgCoh_20091012_20091023_29] --STACK 1
	,[AvgCoh_20091012_20091114_30] --STACK 1
	,[AvgCoh_20091012_20100108_31] --STACK 1
	,[AvgCoh_20091023_20091114_32] --STACK 1
	,[AvgCoh_20091023_20100108_33] --STACK 1
	,[AvgCoh_20091023_20100119_34] --STACK 1
	,[AvgCoh_20091114_20091206_35] --STACK 1
	,[AvgCoh_20091114_20091217_36] --STACK 1
	,[AvgCoh_20091114_20100108_37] --STACK 1
	,[AvgCoh_20091114_20100119_38] --STACK 1
	,[AvgCoh_20091114_20100130_39] --STACK 1
	,[AvgCoh_20091206_20091217_40] --STACK 1
	,[AvgCoh_20091206_20100108_41] --STACK 1
	,[AvgCoh_20091206_20100119_42] --STACK 1
	,[AvgCoh_20091217_20100108_43] --STACK 1
	,[AvgCoh_20091217_20100119_44] --STACK 1
	,[AvgCoh_20091228_20091206_45] --STACK 1
	,[AvgCoh_20091228_20091217_46] --STACK 1
	,[AvgCoh_20100108_20100119_47] --STACK 1
	,[AvgCoh_20100108_20100130_48] --STACK 1
	,[AvgCoh_20100119_20100130_49] --STACK 1
	,[AvgCoh_20110916_20111008_50] --STACK 1
	,[AvgCoh_20110916_20111213_51] --STACK 1
	,[AvgCoh_20111008_20111213_52] --STACK 1
	,[AvgCoh_20111008_20120104_53] --STACK 1
	,[AvgCoh_20111121_20120104_54] --STACK 1
	,[AvgCoh_20111121_20120206_55] --STACK 1
	,[AvgCoh_20111213_20120310_56] --STACK 1
	,[AvgCoh_20120104_20120206_57] --STACK 1
	,[AvgCoh_20120104_20120310_58] --STACK 1
	,[AvgCoh_20120104_20120401_59] --STACK 1
	,[AvgCoh_20120206_20120310_60] --STACK 1
	,[AvgCoh_20120206_20120401_61] --STACK 1
	,[AvgCoh_20120310_20120401_62] --STACK 1
	,[AvgCoh_20120310_20120515_63] --STACK 1
	,[AvgCoh_20120401_20120515_64] --STACK 1
	,[AvgCoh_20120401_20120628_65] --STACK 1
	,[AvgCoh_20120515_20120628_66] --STACK 1
	,[AvgCoh_20120515_20120811_67] --STACK 1
	,[AvgCoh_20120628_20120811_68] --STACK 1
	,[AvgCoh_20120628_20120902_69] --STACK 1
	,[AvgCoh_20120720_20121005_70] --STACK 1
	,[AvgCoh_20120811_20120902_71] --STACK 1
	,[AvgCoh_20130416_20130508_1]  --STACK 2
	,[AvgCoh_20130416_20130621_2]  --STACK 2
	,[AvgCoh_20130508_20130621_3]  --STACK 2
	,[AvgCoh_20130508_20130713_4]  --STACK 2
	,[AvgCoh_20130621_20130917_5]  --STACK 2
	,[AvgCoh_20130713_20130917_6]  --STACK 2
	,[AvgCoh_20130917_20131214_7]  --STACK 2
	,[AvgCoh_20131214_20140312_8]  --STACK 2
	,[AvgCoh_20140312_20140517_9]  --STACK 2
	,[AvgCoh_20140802_20140517_10] --STACK 2
	,[AvgCoh_20140802_20140915_11] --STACK 2
	,[AvgCoh_20140802_20141029_12] --STACK 2
	,[AvgCoh_20141029_20141223_13] --STACK 2
	,[AvgCoh_20150401_20150515_14] --STACK 2
FROM
	[dbo].[STACK_1_EQ_STREETBLOCKS]
JOIN
	[dbo].[STACK_2_EQ_STREETBLOCKS]
ON
	[dbo].[STACK_1_EQ_STREETBLOCKS].STREETBLOCKID = [dbo].[STACK_2_EQ_STREETBLOCKS].STREETBLOCKID


-------------------------------------------------------------------
--     	Select STATISTICS of normalized row format STACK 1 and 2
-------------------------------------------------------------------
use weiboDEV
go
drop table STACK_1_2_EQ_STREETBLOCKS_Statistics
go
select sb.STREETBLOCKID,
	   temp2.Observations,
	   temp2.AverageCoherence,
	   temp2.StandardDevCoherence,	 
	   sb.Shape	
INTO
	STACK_1_2_EQ_STREETBLOCKS_Statistics
from(
Select STREETBLOCKID, 
	   count(*) as Observations,
	   avg([Coherence]) as AverageCoherence,
	   STDEV([Coherence]) as StandardDevCoherence
from 
	(
		  SELECT  * 
		  FROM [dbo].[STACK_1_EQ_STREETBLOCKS_rowformat]
		  UNION All
		  SELECT  * 
		  FROM [dbo].[STACK_2_EQ_STREETBLOCKS_rowformat]) temp
WHERE [Coherence] IS NOT NULL
Group by 
	[STREETBLOCKID]) temp2
FULL JOIN
[dbo].[ALLROADS_RIVERS_BORDERS_TO_POLYGONS_PLUS_POPDATA] as sb
on temp2.STREETBLOCKID = sb.STREETBLOCKID

USE [weiboDEV]
GO
/****** Object:  Index [PK_STACK_1_2_EQ_STREETBLOCKS_Statistics]    Script Date: 11/24/2015 11:19:30 AM ******/
ALTER TABLE [dbo].[STACK_1_2_EQ_STREETBLOCKS_Statistics] ADD  CONSTRAINT [PK_STACK_1_2_EQ_STREETBLOCKS_Statistics] PRIMARY KEY CLUSTERED 
(
	[STREETBLOCKID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
GO
USE [weiboDEV]
GO
SET ARITHABORT ON
SET CONCAT_NULL_YIELDS_NULL ON
SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
SET NUMERIC_ROUNDABORT OFF
GO
CREATE SPATIAL INDEX [SI_Shape] ON [dbo].[STACK_1_2_EQ_STREETBLOCKS_Statistics]
(
	[Shape]
)USING  GEOGRAPHY_AUTO_GRID 
WITH (
CELLS_PER_OBJECT = 16, PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)

GO
