-- STATISTICS FOR EVERY STREETBLOCK
USE weiboDEV
GO
DROP TABLE STACK_2_EQ_STREETBLOCKS
Select 
	 -- these are the columns of the final table 
	 SB.OBJECTID AS STREETBLOCKID
	,STACK2.PointCOUNT as PointCount
	,STACK2.PointCOUNT/SB.AREA AS PointDensity
	,STACK2.AvgCoh_20130416_20130508_1
	,STACK2.AvgCoh_20130416_20130621_2
	,STACK2.AvgCoh_20130508_20130621_3
	,STACK2.AvgCoh_20130508_20130713_4
	,STACK2.AvgCoh_20130621_20130917_5
	,STACK2.AvgCoh_20130713_20130917_6
	,STACK2.AvgCoh_20130917_20131214_7
	,STACK2.AvgCoh_20131214_20140312_8
	,STACK2.AvgCoh_20140312_20140517_9
	,STACK2.AvgCoh_20140802_20140517_10
	,STACK2.AvgCoh_20140802_20140915_11
	,STACK2.AvgCoh_20140802_20141029_12
	,STACK2.AvgCoh_20141029_20141223_13
	,STACK2.AvgCoh_20150401_20150515_14
	,SB.[Shape]
INTO
	STACK_2_EQ_STREETBLOCKS
FROM 
	[weiboDEV].[dbo].ALLROADS_RIVERS_BORDERS_TO_POLYGONS_PLUS_POPDATA SB
LEFT OUTER JOIN 
	(	SELECT 
			 [weiboDEV].[dbo].[STACK2_LINK_ID_to_STREETBLOOKID].[STREETBLOCKID]
			,COUNT([weiboDEV].[dbo].[STACK2_rfEQ].ID) AS PointCOUNT
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img1]) AS AvgCoh_20130416_20130508_1
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img2]) AS AvgCoh_20130416_20130621_2
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img3]) AS AvgCoh_20130508_20130621_3
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img4]) AS AvgCoh_20130508_20130713_4
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img5]) AS AvgCoh_20130621_20130917_5
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img6]) AS AvgCoh_20130713_20130917_6
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img7]) AS AvgCoh_20130917_20131214_7
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img8]) AS AvgCoh_20131214_20140312_8
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img9]) AS AvgCoh_20140312_20140517_9
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img10]) AS AvgCoh_20140802_20140517_10
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img11]) AS AvgCoh_20140802_20140915_11
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img12]) AS AvgCoh_20140802_20141029_12
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img13]) AS AvgCoh_20141029_20141223_13
			,AVG([weiboDEV].[dbo].[STACK2_rfEQ].[img14]) AS AvgCoh_20150401_20150515_14
		FROM 
			[weiboDEV].[dbo].[STACK2_LINK_ID_to_STREETBLOOKID]
		JOIN 
			[weiboDEV].[dbo].[STACK2_rfEQ]
		ON
			[weiboDEV].[dbo].[STACK2_LINK_ID_to_STREETBLOOKID].[ID] = [weiboDEV].[dbo].[STACK2_rfEQ].[ID]
		GROUP BY 
			[weiboDEV].[dbo].[STACK2_LINK_ID_to_STREETBLOOKID].STREETBLOCKID
	) STACK2 ON (SB.OBJECTID=STACK2.STREETBLOCKID)


ALTER TABLE [dbo].[STACK_2_EQ_STREETBLOCKS] ADD  CONSTRAINT [PK_STACK_2_EQ_STREETBLOCKS_STREETBLOCKID] PRIMARY KEY CLUSTERED 
(
	[STREETBLOCKID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)

SET ARITHABORT ON
SET CONCAT_NULL_YIELDS_NULL ON
SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
SET NUMERIC_ROUNDABORT OFF
GO
CREATE SPATIAL INDEX [SI_STACK_2_EQ_STREETBLOCKS] ON [dbo].[STACK_2_EQ_STREETBLOCKS]
(
	[Shape]
)USING  GEOGRAPHY_AUTO_GRID 
WITH (
CELLS_PER_OBJECT = 16, PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)
